<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>redis必须掌握几个知识点 - Troy的网络博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Troy" /><meta name="description" content="redis学习过程" /><meta name="keywords" content="daily-interview-question, Github, c&#43;&#43;, Leetcode 题解, 后端面试" />






<meta name="generator" content="Hugo 0.58.3 with theme even" />


<link rel="canonical" href="https://wangcy6.github.io/post/DataBase/server_redis/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="redis必须掌握几个知识点" />
<meta property="og:description" content="redis学习过程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangcy6.github.io/post/DataBase/server_redis/" />
<meta property="article:published_time" content="2019-12-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-12-02T00:00:00+00:00" />
<meta itemprop="name" content="redis必须掌握几个知识点">
<meta itemprop="description" content="redis学习过程">


<meta itemprop="datePublished" content="2019-12-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-12-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3577">



<meta itemprop="keywords" content="redis," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="redis必须掌握几个知识点"/>
<meta name="twitter:description" content="redis学习过程"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="https://github.com/wangcy6/weekly/tree/master/book">
        <li class="mobile-menu-item">阅读清单</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://github.com/wangcy6/weekly/tree/master/book">阅读清单</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">redis必须掌握几个知识点</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-12-02 00:00 </span>
        <div class="post-category">
            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"> 数据库 </a>
            </div>
          <span class="more-meta"> 约 3577 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#版本">版本</a>
<ul>
<li>
<ul>
<li><a href="#源码阅读参考">源码阅读参考</a></li>
</ul></li>
<li><a href="#fqa">FQA</a></li>
</ul></li>
<li><a href="#第一天-what-is-redis">第一天 what is Redis</a>
<ul>
<li><a href="#学习资料">学习资料</a>
<ul>
<li>
<ul>
<li><a href="#redis-cluster-specification-https-redis-io-topics-cluster-spec"><a href="https://redis.io/topics/cluster-spec">Redis Cluster Specification</a></a></li>
</ul></li>
</ul></li>
<li><a href="#redis-cluster-goals">Redis Cluster goals</a></li>
<li><a href="#学习输出">学习输出</a>
<ul>
<li><a href="#1-陈咬金第一斧-模型什么">#1 陈咬金第一斧  模型什么</a></li>
<li><a href="#2-陈咬金第二斧-数据状态是什么">#2 陈咬金第二斧  数据状态是什么</a></li>
<li><a href="#1-fail状态">1 FAIL状态</a></li>
<li><a href="#2-slave-发起投票条件">2 slave 发起投票条件</a></li>
<li><a href="#3-主节点投票条件">3 主节点投票条件</a></li>
<li><a href="#4-redis-cluster数据分片机制">4. Redis Cluster数据分片机制</a></li>
<li><a href="#2-陈咬金第二斧-clustercron-过程">#2 陈咬金第二斧  clusterCron 过程</a>
<ul>
<li>
<ul>
<li><a href="#clusterhandleslavefailover-故障转移流程">clusterHandleSlaveFailover 故障转移流程</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#第二天-what-is-clustercron">第二天：what is clusterCron</a>
<ul>
<li>
<ul>
<li><a href="#a-学习资料">A 学习资料：</a></li>
<li><a href="#b-学习输出-有限状态机">B 学习输出：有限状态机</a>
<ul>
<li>
<ul>
<li><a href="#陈咬金第一斧-模型什么">#陈咬金第一斧  模型什么</a></li>
<li><a href="#陈咬金第二斧-状态状态是什么">#陈咬金第二斧  状态状态是什么</a></li>
<li><a href="#陈咬金第三斧-有什么用">#陈咬金第三斧  有什么用</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#第三天-内存模型-对象的类型与编码">第三天： 内存模型（对象的类型与编码）</a></li>
<li><a href="#第四天-发布-订阅-publish-subscribe">第四天： <strong>发布-订阅（Publish-Subscribe）</strong></a></li>
<li><a href="#第五天-一个完整socket过程">第五天 一个完整Socket过程</a>
<ul>
<li><a href="#5-1-参考资料">5.1 参考资料</a></li>
<li><a href="#5-2-理解输出">5.2 理解输出</a>
<ul>
<li>
<ul>
<li><a href="#陈咬金第一斧-模型什么-1">#陈咬金第一斧  模型什么</a></li>
<li><a href="#陈咬金第二斧-状态状态是什么-1">#陈咬金第二斧  状态状态是什么</a></li>
<li><a href="#陈咬金第三斧-有什么用-1">#陈咬金第三斧  有什么用</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="版本">版本</h1>

<blockquote>
<p>最新特性是什么</p>
</blockquote>

<table>
<thead>
<tr>
<th>版本</th>
<th>发布日期</th>
<th>其中一个特性</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>Redis2.8</strong></td>
<td>2013年11月22</td>
<td>一个key的类型和编码类型是什么？</td>
</tr>

<tr>
<td><strong>Redis3.0（里程碑）</strong></td>
<td>2015年4月1日</td>
<td>集群方案是什么</td>
</tr>

<tr>
<td><strong>Redis5.0</strong></td>
<td>2018年10月17</td>
<td></td>
</tr>

<tr>
<td><strong>Redis6.0</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="源码阅读参考">源码阅读参考</h3>

<ul>
<li><a href="https://github.com/huangz1990/redis-3.0-annotated">https://github.com/huangz1990/redis-3.0-annotated</a></li>
<li><a href="https://redissrc.readthedocs.io/en/latest/">https://redissrc.readthedocs.io/en/latest/</a></li>
</ul>

<h2 id="fqa">FQA</h2>

<ul>
<li>一个key的类型和编码类型是什么？</li>
<li>redis集群方案</li>
</ul>

<h1 id="第一天-what-is-redis">第一天 what is Redis</h1>

<h2 id="学习资料">学习资料</h2>

<h4 id="redis-cluster-specification-https-redis-io-topics-cluster-spec"><a href="https://redis.io/topics/cluster-spec">Redis Cluster Specification</a></h4>

<p>目标：</p>

<h2 id="redis-cluster-goals">Redis Cluster goals</h2>

<p>Redis Cluster is a distributed implementation of Redis with the following goals, in order of importance in the design:</p>

<ul>
<li>High performance and linear scalability up to 1000 nodes. There are no proxies, asynchronous replication is used, and no merge operations are performed on values.</li>
</ul>

<blockquote>
<p>最高扩展到1000个节点，拿到不能超过吗、为什么这样说</p>
</blockquote>

<ul>
<li><p>Acceptable degree of write safety: the system tries (in a best-effort way) to retain all the writes originating from clients connected with the majority of the master nodes. Usually there are small windows where acknowledged writes can be lost. Windows to lose acknowledged writes are larger when clients are in a minority partition.</p></li>

<li><p>Availability: Redis Cluster is able to survive partitions where the majority of the master nodes are reachable and there is at least one reachable slave for every master node that is no longer reachable. Moreover using <em>replicas migration</em>, masters no longer replicated by any slave will receive one from a master which is covered by multiple slaves.</p></li>
</ul>

<h2 id="学习输出">学习输出</h2>

<h3 id="1-陈咬金第一斧-模型什么">#1 陈咬金第一斧  模型什么</h3>

<p><img src="https://i.loli.net/2019/12/12/BQ71msoKGqyjMzC.png" alt="image.png" /></p>

<h3 id="2-陈咬金第二斧-数据状态是什么">#2 陈咬金第二斧  数据状态是什么</h3>

<p><img src="https://i.loli.net/2019/12/12/KecbMoSi3Nw6HEU.png" alt="https://catkang.github.io/2016/05/08/redis-cluster-source.html" /></p>

<p><img src="https://i.loli.net/2019/12/12/YbVaW6ZjHCQRUJu.png" alt="image.png" /></p>

<h3 id="1-fail状态">1 FAIL状态</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">A</span> <span class="n">PFAIL</span> <span class="n">condition</span> <span class="n">is</span> <span class="n">escalated</span> <span class="n">to</span> <span class="n">a</span> <span class="n">FAIL</span> <span class="n">condition</span> <span class="n">when</span> <span class="n">the</span> <span class="n">following</span> <span class="n">set</span> <span class="n">of</span> <span class="n">conditions</span> <span class="n">are</span> <span class="nl">met</span><span class="p">:</span>

<span class="n">Some</span> <span class="n">node</span><span class="p">,</span> <span class="n">that</span> <span class="n">we</span><span class="err">&#39;</span><span class="n">ll</span> <span class="n">call</span> <span class="n">A</span><span class="p">,</span> <span class="n">has</span> <span class="n">another</span> <span class="n">node</span> <span class="n">B</span> <span class="n">flagged</span> <span class="n">as</span> <span class="n">PFAIL</span><span class="p">.</span>
<span class="n">Node</span> <span class="n">A</span> <span class="n">collected</span><span class="p">,</span> <span class="n">via</span> <span class="n">gossip</span> <span class="n">sections</span><span class="p">,</span> <span class="n">information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="n">B</span> <span class="n">from</span> <span class="n">the</span> <span class="n">point</span> <span class="n">of</span> <span class="n">view</span> <span class="n">of</span> <span class="n">the</span> <span class="n">majority</span> <span class="n">of</span> <span class="n">masters</span> <span class="n">in</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
<span class="n">The</span> <span class="n">majority</span> <span class="n">of</span> <span class="n">masters</span> <span class="n">signaled</span> <span class="n">the</span> <span class="n">PFAIL</span> <span class="n">or</span> <span class="n">FAIL</span> <span class="n">condition</span> <span class="n">within</span> <span class="n">NODE_TIMEOUT</span> <span class="o">*</span> <span class="n">FAIL_REPORT_VALIDITY_MULT</span> <span class="n">time</span><span class="p">.</span> <span class="p">(</span><span class="n">The</span> <span class="n">validity</span> <span class="n">factor</span> <span class="n">is</span> <span class="n">set</span> <span class="n">to</span> <span class="mi">2</span> <span class="n">in</span> <span class="n">the</span> <span class="n">current</span> <span class="n">implementation</span><span class="p">,</span> <span class="n">so</span> <span class="n">this</span> <span class="n">is</span> <span class="n">just</span> <span class="n">two</span> <span class="n">times</span> <span class="n">the</span> <span class="n">NODE_TIMEOUT</span> <span class="n">time</span><span class="p">).</span>
<span class="n">If</span> <span class="n">all</span> <span class="n">the</span> <span class="n">above</span> <span class="n">conditions</span> <span class="n">are</span> <span class="nb">true</span><span class="p">,</span> <span class="n">Node</span> <span class="n">A</span> <span class="nl">will</span><span class="p">:</span>

<span class="n">Mark</span> <span class="n">the</span> <span class="n">node</span> <span class="n">as</span> <span class="n">FAIL</span><span class="p">.</span>
<span class="n">Send</span> <span class="n">a</span> <span class="n">FAIL</span> <span class="n">message</span> <span class="n">to</span> <span class="n">all</span> <span class="n">the</span> <span class="n">reachable</span> <span class="n">nodes</span><span class="p">.</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="2-slave-发起投票条件">2 slave 发起投票条件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">于挂掉的master可能会有多个slave，从而存在多个slave竞争成为master节点的过程， 其过程如下：

<span class="m">1</span>.slave发现自己的master变为FAIL
<span class="m">2</span>.将自己记录的集群currentEpoch加1，并广播FAILOVER_AUTH_REQUEST信息
<span class="m">3</span>.其他节点收到该信息，只有master响应，判断请求者的合法性，并发送FAILOVER_AUTH

<span class="m">4</span>.尝试failover的slave收集FAILOVER_AUTH_ACK
<span class="m">5</span>.超过半数后变成新Master
<span class="m">6</span>.广播Pong通知其他集群节点。

A slave starts an election when the following conditions are met:

<span class="m">1</span> The slave<span class="s1">&#39;s master is in FAIL state.
</span><span class="s1">2 The master was serving a non-zero number of slots.
</span><span class="s1">3 The slave replication link was disconnected from the master for no longer than a given amount of time, in order to ensure the promoted slave&#39;</span>s data is reasonably fresh. 
This <span class="nb">time</span> is user configurable.</code></pre></td></tr></table>
</div>
</div>
<h3 id="3-主节点投票条件">3 主节点投票条件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-scss" data-lang="scss"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-scss" data-lang="scss"><span class="nt">主节点接收到来自于从节点</span><span class="err">、</span><span class="nt">要求以</span> <span class="nt">FAILOVER_AUTH_REQUEST</span> <span class="nt">请求的形式投票的请求</span><span class="err">。</span> 
<span class="nt">要授予一个投票</span><span class="err">，</span><span class="nt">必须要满足以下条件</span><span class="err">：</span>

<span class="nt">1</span><span class="o">)</span> <span class="nt">在一个给定的时段</span><span class="err">（</span><span class="nt">epoch</span><span class="err">）</span><span class="nt">里</span><span class="err">，</span><span class="nt">一个主节点只能投一次票</span><span class="err">，</span><span class="nt">并且拒绝给以前时段投票</span><span class="err">：</span><span class="nt">每个主节点都有一个</span> <span class="nt">lastVoteEpoch</span> <span class="nt">域</span><span class="err">，</span><span class="nt">一旦认证请求数据包</span><span class="err">（</span><span class="nt">auth</span> <span class="nt">request</span> <span class="nt">packet</span><span class="err">）</span><span class="nt">里的</span> <span class="nt">currentEpoch</span> <span class="nt">小于</span> <span class="nt">lastVoteEpoch</span><span class="err">，</span><span class="nt">那么主节点就会拒绝再次投票</span><span class="err">。</span>
  <span class="nt">当一个主节点积极响应一个投票请求</span><span class="err">，</span><span class="nt">那么</span> <span class="nt">lastVoteEpoch</span> <span class="nt">会相应地进行更新</span><span class="err">。</span>
<span class="nt">2</span><span class="o">)</span> <span class="nt">一个主节点投票给某个从节点当且仅当该从节点的主节点被标记为</span> <span class="nt">FAIL</span><span class="err">。</span>
<span class="nt">3</span><span class="o">)</span> <span class="nt">如果认证请求里的</span> <span class="nt">currentEpoch</span> <span class="nt">小于主节点里的</span> <span class="nt">currentEpoch</span> <span class="nt">的话</span><span class="err">，</span><span class="nt">那么该请求会被忽视掉</span><span class="err">。</span>
    <span class="nt">因此</span><span class="err">，</span><span class="nt">主节点的回应总是带着和认证请求一致的</span> <span class="nt">currentEpoch</span><span class="err">。</span>
    <span class="nt">如果同一个从节点在增加</span> <span class="nt">currentEpoch</span> <span class="nt">后再次请求投票</span><span class="err">，</span><span class="nt">那么保证一个来自于主节点的</span><span class="err">、</span><span class="nt">旧的延迟回复不会被新一轮选举接受</span><span class="err">。</span>
    

<span class="nt">For</span> <span class="nt">a</span> <span class="nt">vote</span> <span class="nt">to</span> <span class="nt">be</span> <span class="nt">granted</span> <span class="nt">the</span> <span class="nt">following</span> <span class="nt">conditions</span> <span class="nt">need</span> <span class="nt">to</span> <span class="nt">be</span> <span class="nt">met</span><span class="nd">:</span>

<span class="nt">1</span><span class="nc">.</span>  <span class="nt">A</span> <span class="nt">master</span> <span class="nt">only</span> <span class="nt">votes</span> <span class="nt">a</span> <span class="nt">single</span> <span class="nt">time</span> <span class="nt">for</span> <span class="nt">a</span> <span class="nt">given</span> <span class="nt">epoch</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">refuses</span> <span class="nt">to</span> <span class="nt">vote</span> <span class="nt">for</span> <span class="nt">older</span> <span class="nt">epochs</span><span class="nd">:</span> <span class="nt">every</span> <span class="nt">master</span> <span class="nt">has</span> <span class="nt">a</span> <span class="nt">lastVoteEpoch</span> <span class="nt">field</span> <span class="nt">and</span> <span class="nt">will</span> <span class="nt">refuse</span> <span class="nt">to</span> <span class="nt">vote</span> <span class="nt">again</span> <span class="nt">as</span> <span class="nt">long</span> <span class="nt">as</span> <span class="nt">the</span> <span class="nt">currentEpoch</span> <span class="nt">in</span> <span class="nt">the</span> <span class="nt">auth</span> <span class="nt">request</span> <span class="nt">packet</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">greater</span> <span class="nt">than</span> <span class="nt">the</span> <span class="nt">lastVoteEpoch</span><span class="nc">.</span> 
    <span class="nt">When</span> <span class="nt">a</span> <span class="nt">master</span> <span class="nt">replies</span> <span class="nt">positively</span> <span class="nt">to</span> <span class="nt">a</span> <span class="nt">vote</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">the</span> <span class="nt">lastVoteEpoch</span> <span class="nt">is</span> <span class="nt">updated</span> <span class="nt">accordingly</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">safely</span> <span class="nt">stored</span> <span class="nt">on</span> <span class="nt">disk</span><span class="nc">.</span>

<span class="nt">2</span><span class="nc">.</span>  <span class="nt">A</span> <span class="nt">master</span> <span class="nt">votes</span> <span class="nt">for</span> <span class="nt">a</span> <span class="nt">slave</span> <span class="nt">only</span> <span class="nt">if</span> <span class="nt">the</span> <span class="nt">slave</span><span class="s1">&#39;</span><span class="s2">s master is flagged as FAIL.</span>

<span class="nt">3</span><span class="nc">.</span>  <span class="nt">Auth</span> <span class="nt">requests</span> <span class="nt">with</span> <span class="nt">a</span> <span class="nt">currentEpoch</span> <span class="nt">that</span> <span class="nt">is</span> <span class="nt">less</span> <span class="nt">than</span> <span class="nt">the</span> <span class="nt">master</span> <span class="nt">currentEpoch</span> <span class="nt">are</span> <span class="nt">ignored</span><span class="nc">.</span> <span class="nt">Because</span> <span class="nt">of</span> <span class="nt">this</span> <span class="nt">the</span> <span class="nt">master</span> <span class="nt">reply</span> <span class="nt">will</span> <span class="nt">always</span> <span class="nt">have</span> <span class="nt">the</span> <span class="nt">same</span> <span class="nt">currentEpoch</span> <span class="nt">as</span> <span class="nt">the</span> <span class="nt">auth</span> <span class="nt">request</span><span class="nc">.</span> <span class="nt">If</span> <span class="nt">the</span> <span class="nt">same</span> <span class="nt">slave</span> <span class="nt">asks</span> <span class="nt">again</span> <span class="nt">to</span> <span class="nt">be</span> <span class="nt">voted</span><span class="o">,</span> <span class="nt">incrementing</span> <span class="nt">the</span> <span class="nt">currentEpoch</span><span class="o">,</span> <span class="nt">it</span> <span class="nt">is</span> <span class="nt">guaranteed</span> <span class="nt">that</span> <span class="nt">an</span> <span class="nt">old</span> <span class="nt">delayed</span> <span class="nt">reply</span> <span class="nt">from</span> <span class="nt">the</span> <span class="nt">master</span> <span class="nt">can</span> <span class="nt">not</span> <span class="nt">be</span> <span class="nt">accepted</span> <span class="nt">for</span> <span class="nt">the</span> <span class="nt">new</span> <span class="nt">vote</span><span class="nc">.</span>

<span class="o">/*</span> <span class="nt">Vote</span> <span class="nt">for</span> <span class="nt">the</span> <span class="nt">node</span> <span class="nt">asking</span> <span class="nt">for</span> <span class="nt">our</span> <span class="nt">vote</span> <span class="nt">if</span> <span class="nt">there</span> <span class="nt">are</span> <span class="nt">the</span> <span class="nt">conditions</span><span class="nc">.</span> <span class="o">*/</span>
<span class="o">//</span> <span class="nt">在条件满足的情况下</span><span class="err">，</span><span class="nt">为请求进行故障转移的节点</span> <span class="nt">node</span> <span class="nt">进行投票</span><span class="err">，</span><span class="nt">支持它进行故障转移</span>
<span class="o">///</span><span class="nt">主节点投票</span>
<span class="nt">void</span> <span class="nt">clusterSendFailoverAuthIfNeeded</span><span class="o">(</span><span class="nt">clusterNode</span> <span class="o">*</span><span class="nt">node</span><span class="o">,</span> <span class="nt">clusterMsg</span> <span class="o">*</span><span class="nt">request</span><span class="o">)</span> <span class="p">{</span>

    <span class="c1">// 请求节点的主节点
</span><span class="c1"></span>    <span class="nt">clusterNode</span> <span class="o">*</span><span class="nt">master</span> <span class="o">=</span> <span class="nt">node-</span><span class="o">&gt;</span><span class="nt">slaveof</span><span class="o">;</span>

    <span class="o">//</span> <span class="nt">请求节点的当前配置纪元</span>
    <span class="nt">uint64_t</span> <span class="nt">requestCurrentEpoch</span> <span class="o">=</span> <span class="nt">ntohu64</span><span class="o">(</span><span class="nt">request-</span><span class="o">&gt;</span><span class="nt">currentEpoch</span><span class="o">);</span>

    <span class="o">//</span> <span class="nt">请求节点想要获得投票的纪元</span>
    <span class="nt">uint64_t</span> <span class="nt">requestConfigEpoch</span> <span class="o">=</span> <span class="nt">ntohu64</span><span class="o">(</span><span class="nt">request-</span><span class="o">&gt;</span><span class="nt">configEpoch</span><span class="o">);</span>

    <span class="o">//</span> <span class="nt">请求节点的槽布局</span>
    <span class="nt">unsigned</span> <span class="nt">char</span> <span class="o">*</span><span class="nt">claimed_slots</span> <span class="o">=</span> <span class="nt">request-</span><span class="o">&gt;</span><span class="nt">myslots</span><span class="o">;</span>
    <span class="nt">int</span> <span class="nt">force_ack</span> <span class="o">=</span> <span class="nt">request-</span><span class="o">&gt;</span><span class="nt">mflags</span><span class="o">[</span><span class="nt">0</span><span class="o">]</span> <span class="k">&amp;</span> <span class="nt">CLUSTERMSG_FLAG0_FORCEACK</span><span class="o">;</span>
    <span class="nt">int</span> <span class="nt">j</span><span class="o">;</span>

    <span class="o">/*</span> <span class="nt">IF</span> <span class="nt">we</span> <span class="nt">are</span> <span class="nt">not</span> <span class="nt">a</span> <span class="nt">master</span> <span class="nt">serving</span> <span class="nt">at</span> <span class="nt">least</span> <span class="nt">1</span> <span class="nt">slot</span><span class="o">,</span> <span class="nt">we</span> <span class="nt">don</span><span class="s1">&#39;</span><span class="s2">t have the</span>
     <span class="o">*</span> <span class="nt">right</span> <span class="nt">to</span> <span class="nt">vote</span><span class="o">,</span> <span class="nt">as</span> <span class="nt">the</span> <span class="nt">cluster</span> <span class="nt">size</span> <span class="nt">in</span> <span class="nt">Redis</span> <span class="nt">Cluster</span> <span class="nt">is</span> <span class="nt">the</span> <span class="nt">number</span>
     <span class="o">*</span> <span class="nt">of</span> <span class="nt">masters</span> <span class="nt">serving</span> <span class="nt">at</span> <span class="nt">least</span> <span class="nt">one</span> <span class="nt">slot</span><span class="o">,</span> <span class="nt">and</span> <span class="nt">quorum</span> <span class="nt">is</span> <span class="nt">the</span> <span class="nt">cluster</span>
     <span class="o">*</span> <span class="nt">size</span> <span class="o">+</span> <span class="nt">1</span> <span class="o">*/</span>

    <span class="o">//</span> <span class="nt">如果节点为从节点</span><span class="err">，</span><span class="nt">或者是一个没有处理任何槽的主节点</span><span class="err">，</span>
    <span class="o">//</span> <span class="nt">那么它没有投票权</span>
    <span class="nt">if</span> <span class="o">(</span><span class="nt">nodeIsSlave</span><span class="o">(</span><span class="nt">myself</span><span class="o">)</span> <span class="o">||</span> <span class="nt">myself-</span><span class="o">&gt;</span><span class="nt">numslots</span> <span class="o">==</span> <span class="nt">0</span><span class="o">)</span> <span class="nt">return</span><span class="o">;</span>

    <span class="o">/*</span> <span class="nt">Request</span> <span class="nt">epoch</span> <span class="nt">must</span> <span class="nt">be</span> <span class="o">&gt;=</span> <span class="nt">our</span> <span class="nt">currentEpoch</span><span class="nc">.</span> <span class="o">*/</span>
    <span class="o">//</span> <span class="nt">请求的配置纪元必须大于等于当前节点的配置纪元</span>
    <span class="nt">if</span> <span class="o">(</span><span class="nt">requestCurrentEpoch</span> <span class="o">&lt;</span> <span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">currentEpoch</span><span class="o">)</span> <span class="nt">return</span><span class="o">;</span>

    <span class="o">/*</span> <span class="nt">I</span> <span class="nt">already</span> <span class="nt">voted</span> <span class="nt">for</span> <span class="nt">this</span> <span class="nt">epoch</span><span class="o">?</span> <span class="nt">Return</span> <span class="nt">ASAP</span><span class="nc">.</span> <span class="o">*/</span>
    <span class="o">//</span> <span class="nt">已经投过票了</span>
    <span class="nt">if</span> <span class="o">(</span><span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">lastVoteEpoch</span> <span class="o">==</span> <span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">currentEpoch</span><span class="o">)</span> <span class="nt">return</span><span class="o">;</span>

    <span class="o">/*</span> <span class="nt">Node</span> <span class="nt">must</span> <span class="nt">be</span> <span class="nt">a</span> <span class="nt">slave</span> <span class="nt">and</span> <span class="nt">its</span> <span class="nt">master</span> <span class="nt">down</span><span class="nc">.</span>
     <span class="o">*</span> <span class="nt">The</span> <span class="nt">master</span> <span class="nt">can</span> <span class="nt">be</span> <span class="nt">non</span> <span class="nt">failing</span> <span class="nt">if</span> <span class="nt">the</span> <span class="nt">request</span> <span class="nt">is</span> <span class="nt">flagged</span>
     <span class="o">*</span> <span class="nt">with</span> <span class="nt">CLUSTERMSG_FLAG0_FORCEACK</span> <span class="o">(</span><span class="nt">manual</span> <span class="nt">failover</span><span class="o">)</span><span class="nc">.</span> <span class="o">*/</span>
    <span class="nt">if</span> <span class="o">(</span><span class="nt">nodeIsMaster</span><span class="o">(</span><span class="nt">node</span><span class="o">)</span> <span class="o">||</span> <span class="nt">master</span> <span class="o">==</span> <span class="nt">NULL</span> <span class="o">||</span>
        <span class="o">(!</span><span class="nt">nodeFailed</span><span class="o">(</span><span class="nt">master</span><span class="o">)</span> <span class="k">&amp;&amp;</span> <span class="o">!</span><span class="nt">force_ack</span><span class="o">))</span> <span class="nt">return</span><span class="o">;</span>

    <span class="o">/*</span> <span class="nt">We</span> <span class="nt">did</span> <span class="nt">not</span> <span class="nt">voted</span> <span class="nt">for</span> <span class="nt">a</span> <span class="nt">slave</span> <span class="nt">about</span> <span class="nt">this</span> <span class="nt">master</span> <span class="nt">for</span> <span class="nt">two</span>
     <span class="o">*</span> <span class="nt">times</span> <span class="nt">the</span> <span class="nt">node</span> <span class="nt">timeout</span><span class="nc">.</span> <span class="nt">This</span> <span class="nt">is</span> <span class="nt">not</span> <span class="nt">strictly</span> <span class="nt">needed</span> <span class="nt">for</span> <span class="nt">correctness</span>
     <span class="o">*</span> <span class="nt">of</span> <span class="nt">the</span> <span class="nt">algorithm</span> <span class="nt">but</span> <span class="nt">makes</span> <span class="nt">the</span> <span class="nt">base</span> <span class="nt">case</span> <span class="nt">more</span> <span class="nt">linear</span><span class="nc">.</span> <span class="o">*/</span>
    <span class="o">//</span> <span class="nt">如果之前一段时间已经对请求节点进行过投票</span><span class="err">，</span><span class="nt">那么不进行投票</span>
    <span class="nt">if</span> <span class="o">(</span><span class="nt">mstime</span><span class="o">()</span> <span class="nt">-</span> <span class="nt">node-</span><span class="o">&gt;</span><span class="nt">slaveof-</span><span class="o">&gt;</span><span class="nt">voted_time</span> <span class="o">&lt;</span> <span class="nt">server</span><span class="nc">.cluster_node_timeout</span> <span class="o">*</span> <span class="nt">2</span><span class="o">)</span>
        <span class="nt">return</span><span class="o">;</span>

    <span class="o">/*</span> <span class="nt">The</span> <span class="nt">slave</span> <span class="nt">requesting</span> <span class="nt">the</span> <span class="nt">vote</span> <span class="nt">must</span> <span class="nt">have</span> <span class="nt">a</span> <span class="nt">configEpoch</span> <span class="nt">for</span> <span class="nt">the</span> <span class="nt">claimed</span>
     <span class="o">*</span> <span class="nt">slots</span> <span class="nt">that</span> <span class="nt">is</span> <span class="o">&gt;=</span> <span class="nt">the</span> <span class="nt">one</span> <span class="nt">of</span> <span class="nt">the</span> <span class="nt">masters</span> <span class="nt">currently</span> <span class="nt">serving</span> <span class="nt">the</span> <span class="nt">same</span>
     <span class="o">*</span> <span class="nt">slots</span> <span class="nt">in</span> <span class="nt">the</span> <span class="nt">current</span> <span class="nt">configuration</span><span class="nc">.</span> <span class="o">*/</span>
    <span class="nt">for</span> <span class="o">(</span><span class="nt">j</span> <span class="o">=</span> <span class="nt">0</span><span class="o">;</span> <span class="nt">j</span> <span class="o">&lt;</span> <span class="nt">REDIS_CLUSTER_SLOTS</span><span class="o">;</span> <span class="nt">j</span><span class="o">++)</span> <span class="p">{</span>

        <span class="c1">// 跳过未指派节点
</span><span class="c1"></span>        <span class="nt">if</span> <span class="o">(</span><span class="nt">bitmapTestBit</span><span class="o">(</span><span class="nt">claimed_slots</span><span class="o">,</span> <span class="nt">j</span><span class="o">)</span> <span class="o">==</span> <span class="nt">0</span><span class="o">)</span> <span class="nt">continue</span><span class="o">;</span>

        <span class="o">//</span> <span class="nt">查找是否有某个槽的配置纪元大于节点请求的纪元</span>
        <span class="nt">if</span> <span class="o">(</span><span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">slots</span><span class="o">[</span><span class="nt">j</span><span class="o">]</span> <span class="o">==</span> <span class="nt">NULL</span> <span class="o">||</span>
            <span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">slots</span><span class="o">[</span><span class="nt">j</span><span class="o">]</span><span class="nt">-</span><span class="o">&gt;</span><span class="nt">configEpoch</span> <span class="o">&lt;=</span> <span class="nt">requestConfigEpoch</span><span class="o">)</span>
        <span class="p">{</span>
            <span class="nt">continue</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="c1">// 如果有的话，说明节点请求的纪元已经过期，没有必要进行投票
</span><span class="c1"></span>        <span class="cm">/* If we reached this point we found a slot that in our current slots
</span><span class="cm">         * is served by a master with a greater configEpoch than the one claimed
</span><span class="cm">         * by the slave requesting our vote. Refuse to vote for this slave. */</span>
        <span class="nt">return</span><span class="o">;</span>
    <span class="p">}</span>

    <span class="cm">/* We can vote for this slave. */</span>
    <span class="c1">// 为节点投票
</span><span class="c1"></span>    <span class="nt">clusterSendFailoverAuth</span><span class="o">(</span><span class="nt">node</span><span class="o">);</span>
    <span class="o">//</span> <span class="nt">更新时间值</span>
    <span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">lastVoteEpoch</span> <span class="o">=</span> <span class="nt">server</span><span class="nc">.cluster-</span><span class="o">&gt;</span><span class="nt">currentEpoch</span><span class="o">;</span>
    <span class="nt">node-</span><span class="o">&gt;</span><span class="nt">slaveof-</span><span class="o">&gt;</span><span class="nt">voted_time</span> <span class="o">=</span> <span class="nt">mstime</span><span class="o">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="4-redis-cluster数据分片机制">4. Redis Cluster数据分片机制</h3>

<p>A 问题（读三遍）：Redis的数据如何平滑扩容?</p>

<p>关键词：扩容，还有平滑</p>

<p>为了使得集群能够水平扩展，首要解决的问题就是如何将整个数据集按照一定的规则分配到多个节点上，</p>

<p>平滑扩容是一种<a href="https://help.aliyun.com/document_detail/52132.html?spm=a2c4g.11186623.4.2.527e5096Ac5fpB">在线水平扩容方式</a>，既把原有的分库平滑迁移到新添加的 RDS 实例上</p>

<p>扩展 ：nginx，Strom等其他任何一个服务上</p>

<p>B 思考：</p>

<p>常用的数据分片的方法有：范围分片，哈希分片，<a href="https://yikun.github.io/2016/06/09/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E7%9A%84%E7%90%86%E8%A7%A3%E4%B8%8E%E5%AE%9E%E8%B7%B5/">一致性哈希算法</a>和<strong>虚拟哈希槽</strong>等</p>

<p>范围分片:一旦固定，范围就无法改变</p>

<p>哈希分片，如果想增加一个节点，整个集群的数据完全打破，这就是问题</p>

<p>Redis Cluster 采用<a href="https://www.cnblogs.com/lowmanisbusy/p/10993748.html">虚拟哈希槽分区</a>，所有的键根据哈希函数映射到 0 ~ 16383 整数槽内，计算公式：slot = CRC16(key) &amp; 16383。</p>

<p>每一个节点负责维护一部分槽以及槽所映射的键值数据</p>

<p>c 回答</p>

<ul>
<li><p>一个大数据拆分不同小数据，slot，分批迁移。</p></li>

<li><p>集群状态，清楚知道每个sloat位置</p></li>
</ul>

<h3 id="2-陈咬金第二斧-clustercron-过程">#2 陈咬金第二斧  clusterCron 过程</h3>

<p>每间隔 100 毫秒执行一次</p>

<ol>
<li><p>向集群中的所有断线或者未连接节点发送CLUSTERMSG_TYPE_PING 消息</p></li>

<li><p>隔一秒钟,随机5个节点发送CLUSTERMSG_TYPE_PING 信息</p></li>

<li><p>遍历所有节点，检查是否需要将某个节点标记为下线</p></li>
</ol>

<p>3.1.如果tcp链接断开，释放链接，下次会在1步骤中重新建立链接</p>

<p>3.2 如果该链接没有发送过ping，没有随机到，发送ping 信息</p>

<p><strong>3.3 计算当前时间和该节点上次发送ping时间，如果超过cluster_node_timeout</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma"> **标记 REDIS_NODE_PFAIL 疑似下线标记**</pre></td></tr></table>
</div>
</div>
<p>3.3 如果从节点没有在复制主节点，那么对从节点进行设置【why】</p>

<p>3.4  从节点发起故障转移  clusterHandleSlaveFailover</p>

<p>clusterHandleManualFailover  &ndash;表示没看懂</p>

<p>clusterHandleSlaveMigration &ndash;表示没看懂</p>

<p>3.5 更新集群的节点状态信息 ！！！！ &mdash;REDIS_NODE_PFAIL  REDIS_CLUSTER_FAIL</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c">       <span class="cm">/* Compute the cluster size, that is the number of master nodes
</span><span class="cm">        * serving at least a single slot.
</span><span class="cm">        *
</span><span class="cm">        * At the same time count the number of unreachable masters with
</span><span class="cm">        * at least one node. */</span>
       <span class="c1">// 统计在线并且正在处理至少一个槽的 master 的数量，
</span><span class="c1"></span>       <span class="c1">// 以及下线 master 的数量
</span><span class="c1"></span>       <span class="p">{</span>
           <span class="n">dictIterator</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
           <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">;</span>
   
           <span class="n">server</span><span class="p">.</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetSafeIterator</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
           <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">clusterNode</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
   
               <span class="k">if</span> <span class="p">(</span><span class="n">nodeIsMaster</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">numslots</span><span class="p">)</span> <span class="p">{</span>
                   <span class="n">server</span><span class="p">.</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REDIS_NODE_FAIL</span><span class="o">|</span><span class="n">REDIS_NODE_PFAIL</span><span class="p">))</span>
                       <span class="n">unreachable_masters</span><span class="o">++</span><span class="p">;</span>
               <span class="p">}</span>
           <span class="p">}</span>
           <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
       <span class="p">}</span>
   
   <span class="cm">/* If we can&#39;t reach at least half the masters, change the cluster state
</span><span class="cm">        * to FAIL, as we are not even able to mark nodes as FAIL in this side
</span><span class="cm">        * of the netsplit because of lack of majority.
</span><span class="cm">        *
</span><span class="cm">        * 如果不能连接到半数以上节点，那么将我们自己的状态设置为 FAIL
</span><span class="cm">        * 因为在少于半数节点的情况下，节点是无法将一个节点判断为 FAIL 的。
</span><span class="cm">        */</span>
       <span class="p">{</span>
           <span class="kt">int</span> <span class="n">needed_quorum</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
   
           <span class="k">if</span> <span class="p">(</span><span class="n">unreachable_masters</span> <span class="o">&gt;=</span> <span class="n">needed_quorum</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">new_state</span> <span class="o">=</span> <span class="n">REDIS_CLUSTER_FAIL</span><span class="p">;</span>
               <span class="n">among_minority_time</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
           <span class="p">}</span>
       <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h5 id="clusterhandleslavefailover-故障转移流程">clusterHandleSlaveFailover 故障转移流程</h5>

<ul>
<li><p>如果没有像其他节点发起投票 clusterRequestFailoverAuth</p></li>

<li><p>如果当前节点获得了足够多的投票，那么对下线主节点进行故障转移</p></li>
</ul>

<p>将当前节点的身份由从节点改为主节点</p>

<p>让从节点取消复制，成为新的主节点</p>

<p><strong>接收所有主节点负责处理的槽</strong></p>

<p>更新集群配置纪元</p>

<p>更新节点状态</p>

<p>并保存配置文件</p>

<h1 id="第二天-what-is-clustercron">第二天：what is clusterCron</h1>

<h3 id="a-学习资料">A 学习资料：</h3>

<blockquote>
<p>clusterCron</p>
</blockquote>

<h3 id="b-学习输出-有限状态机">B 学习输出：有限状态机</h3>

<p>有限状态机是个十分有用的模型，可以用来模拟世界上大部分的事物，其有三个特征：</p>

<ol>
<li>状态总数（state）是有限的。</li>
<li>任一时刻，只处在一种状态之中。</li>
<li>某种条件下，会从一种状态转变（transition）到另一种状态。</li>
</ol>

<p><img src="https://image-static.segmentfault.com/292/449/2924490386-56ff88829d057_articlex" alt="FSM" /></p>

<p><a href="http://www.ruanyifeng.com/blog/2013/09/finite-state_machine_for_javascript.html">JavaScript与有限状态机</a></p>

<p><a href="https://colobu.com/2016/12/24/a-featured-fsm/">一个有特色的有限状态机</a></p>

<p><a href="http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm">TCP Operational Overview and the TCP Finite State Machine (FSM)</a></p>

<p><a href="https://www.youtube.com/watch?v=Qa6csfkK7_I">https://www.youtube.com/watch?v=Qa6csfkK7_I</a></p>

<p><img src="http://www.tcpipguide.com/free/diagrams/tcpfsm.png" alt="" /></p>

<h5 id="陈咬金第一斧-模型什么">#陈咬金第一斧  模型什么</h5>

<h5 id="陈咬金第二斧-状态状态是什么">#陈咬金第二斧  状态状态是什么</h5>

<h5 id="陈咬金第三斧-有什么用">#陈咬金第三斧  有什么用</h5>

<h2 id="第三天-内存模型-对象的类型与编码">第三天： 内存模型（对象的类型与编码）</h2>

<p><img src="../images/95JQiMS2gUjWVsN.png" alt="image.png" /></p>

<h2 id="第四天-发布-订阅-publish-subscribe">第四天： <strong>发布-订阅（Publish-Subscribe）</strong></h2>

<h2 id="第五天-一个完整socket过程">第五天 一个完整Socket过程</h2>

<h3 id="5-1-参考资料">5.1 参考资料</h3>

<ul>
<li><p>Unix网络编程卷1</p></li>

<li><p><a href="https://www.infoq.cn/article/communication-redis-clientserver">https://www.infoq.cn/article/communication-redis-clientserver</a></p></li>
</ul>

<p>Redis client/server 交互步骤分为以下 6 个步骤：</p>

<p>一、Client 发起 socket 连接</p>

<p>二、Server 接受 socket 连接</p>

<p>三、客户端 开始写入</p>

<p>四、server 端接收写入</p>

<p>五、server 返回写入结果</p>

<p>六、Client 收到返回结</p>

<h3 id="5-2-理解输出">5.2 理解输出</h3>

<h5 id="陈咬金第一斧-模型什么-1">#陈咬金第一斧  模型什么</h5>

<h5 id="陈咬金第二斧-状态状态是什么-1">#陈咬金第二斧  状态状态是什么</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="p">{</span>

    <span class="c1">// 已注册的文件事件
</span><span class="c1"></span>    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span> <span class="cm">/* Registered events */</span>
    <span class="c1">// 已就绪的文件事件
</span><span class="c1"></span>    <span class="n">aeFiredEvent</span> <span class="o">*</span><span class="n">fired</span><span class="p">;</span> <span class="cm">/* Fired events */</span>  <span class="err">着</span><span class="mi">2</span><span class="err">个有什么关系？</span>
    <span class="c1">// 时间事件
</span><span class="c1"></span>    <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">timeEventHead</span><span class="p">;</span>
<span class="p">}</span> <span class="n">aeEventLoop</span><span class="p">;</span>

<span class="n">readQueryFromClient</span>
    
<span class="n">sendReplyToClient</span>
    <span class="nl">https</span><span class="p">:</span><span class="c1">//stackoverflow.com/questions/28098563/errno-after-accept-in-linux-socket-programming
</span></code></pre></td></tr></table>
</div>
</div>
<h5 id="陈咬金第三斧-有什么用-1">#陈咬金第三斧  有什么用</h5>

<h2 id="参考">参考</h2>

<p><a href="https://groups.google.com/forum/#!topic/redis-db/dY07-dRyHz4">https://groups.google.com/forum/#!topic/redis-db/dY07-dRyHz4</a></p>

<p><a href="http://blog.maihaoche.com/zhuang-tai-ji-si-wei/">http://blog.maihaoche.com/zhuang-tai-ji-si-wei/</a></p>

<p><a href="https://shinley.gitbooks.io/statemachine/28persisting-state-machine.html">https://shinley.gitbooks.io/statemachine/28persisting-state-machine.html</a></p>

<p><a href="http://www.web-lovers.com/redis-source-replication.html">http://www.web-lovers.com/redis-source-replication.html</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Troy</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-12-02 00:00
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/nusr/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/redis/">redis</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/Linux/man/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">man</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E6%8F%90%E9%AB%98%E5%B7%A5%E4%BD%9C%E6%95%88%E7%8E%87%E7%9A%84%E5%87%A0%E4%B8%AA%E5%B7%A5%E5%85%B7/">
            <span class="next-text nav-default">提高工作效率的几个工具</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="wangcy6/wangcy6.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wang_cyi@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wangcy6" class="iconfont icon-github" title="github"></a>
  <a href="https://wangcy6.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Troy</span>
  </span>
</div>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
